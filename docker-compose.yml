version: '3.9'

services:
  # ============================================
  # Reverse Proxy (Caddy - Auto SSL)
  # ============================================
  caddy:
    image: caddy:2.7-alpine
    container_name: auteur-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - DOMAIN=${DOMAIN}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
    networks:
      - auteur-network
    depends_on:
      - frontend
      - backend

  # ============================================
  # Next.js Frontend
  # ============================================
  frontend:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/auteur-frontend:${IMAGE_TAG:-latest}
    container_name: auteur-frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${API_URL}
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
    networks:
      - auteur-network
    depends_on:
      - backend
    # healthcheck:
    #   test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health" ]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s

    # ============================================
    # Spring Boot Backend
    # ============================================
  backend:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER}/auteur-backend:${IMAGE_TAG:-latest}
    container_name: auteur-backend
    restart: unless-stopped
    environment:
      # Supabase Postgres (Managed)
      - SPRING_DATASOURCE_URL=${SUPABASE_DB_URL}
      - SPRING_DATASOURCE_USERNAME=${SUPABASE_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${SUPABASE_DB_PASSWORD}

      # Redis (Local on VPS)
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_DATA_REDIS_PASSWORD=${REDIS_PASSWORD}

      # Supabase Auth
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}

      # MongoDB Atlas (Managed)
      - MONGODB_URI=${MONGODB_URI}

      # Cloudflare R2
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_ACCESS_KEY=${R2_ACCESS_KEY}
      - R2_SECRET_KEY=${R2_SECRET_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}

      # Modal
      - MODAL_TOKEN_ID=${MODAL_TOKEN_ID}
      - MODAL_TOKEN_SECRET=${MODAL_TOKEN_SECRET}

      # App Config
      - SERVER_PORT=8080
      - SPRING_PROFILES_ACTIVE=production
      - JAVA_OPTS=-Xms384m -Xmx768m
    networks:
      - auteur-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # Redis (Streams + Cache) - ONLY service on VPS
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: auteur-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 1gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - auteur-network
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli -a \"$REDIS_PASSWORD\" ping | grep PONG" ]
      interval: 5s
      timeout: 5s
      retries: 5
    # ============================================
    # Networks
    # ============================================
networks:
  auteur-network:
    driver: bridge

# ============================================
# Volumes (Persistent Data)
# ============================================
volumes:
  redis_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
